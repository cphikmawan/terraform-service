---
  version: 3
  projects:

  ##################################### START DEVELOPMENT #####################################

  ## START
    - name: dev-atlantis-server
      dir: atlantis-server
      terraform_version: v0.12.23
      workflow: development
      autoplan:
        when_modified: ["*.tf","development.*"]
        enabled: true
  ## END

  ## START
    - name: dev-webserver-nginx
      dir: webserver-nginx
      terraform_version: v0.12.23
      workflow: development
      autoplan:
        when_modified: ["*.tf","development.*"]
        enabled: true
  ## END

  ##################################### END DEVELOPMENT ###################################

  repos:
    # id can either be an exact repo ID or a regex.
    # If using a regex, it must start and end with a slash.
    # Repo ID's are of the form {VCS hostname}/{org}/{repo name}, ex.
    # github.com/runatlantis/atlantis.
  - id: /.*/

    # apply_requirements sets the Apply Requirements for all repos that match.
    apply_requirements: [mergeable]

    # workflow sets the workflow for all repos that match.
    # This workflow must be defined in the workflows section.
    workflow: [development, staging]

    # allowed_overrides specifies which keys can be overridden by this repo in
    # its atlantis.yaml file.
    allowed_overrides: [apply_requirements, workflow]

    # allow_custom_workflows defines whether this repo can define its own
    # workflows. If false (default), the repo can only use server-side defined
    # workflows.
    allow_custom_workflows: true

    # id can also be an exact match.
  - id: github.com/cphikmawan/terraform-service

  ## WORKFLOW
  workflows:
    development:
      plan:
        steps:
          - run: rm -rf .terraform
          - init:
              extra_args: [-backend-config=development.backend.tfvars]
          - plan:
              extra_args: [-var-file=development.tfvars]
      apply:
        steps:
          - apply:
              extra_args: ["-lock=false"]

    staging:
      plan:
        steps:
          - run: rm -rf .terraform
          - init:
              extra_args: [-backend-config=staging.backend.tfvars]
          - plan:
              extra_args: [-var-file=staging.tfvars]
      apply:
        steps:
          - apply:
              extra_args: ["-lock=false"]
  ## END WORKFLOW
